<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pGluc-Webex 모바일 앱 프로토타입</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>

    <style>
        :root {
            --primary-color: #0052cc;
            --secondary-color: #00a0d1;
            --danger-color: #e94f37;
            --warning-color: #f7a800;
            --success-color: #36b37e;
            --bg-light: #f5f7fa;
            --text-dark: #253858;
            --text-light: #6b778c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            padding-bottom: 70px; /* 하단 네비게이션 바 공간 확보 */
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color);
        }

        .navbar {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: none;
        }

        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-weight: 600;
            padding: 15px 20px;
        }

        .glucose-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .glucose-unit {
            font-size: 1rem;
            color: var(--text-light);
        }

        .glucose-trend {
            font-size: 1.2rem;
            margin-left: 10px;
        }

        .trend-up { color: var(--danger-color); }
        .trend-down { color: var(--warning-color); }
        .trend-stable { color: var(--success-color); }

        .prediction-card {
            background-color: #f0f7ff;
            border-left: 4px solid var(--primary-color);
        }

        .prediction-value {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .prediction-time {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        #alertCardContainer {
             margin-bottom: 20px;
        }
        .alert-card {
            border-left-width: 4px;
            border-left-style: solid;
            background-color: #fff8f8;
            border-left-color: var(--danger-color);
        }
        .alert-card.alert-warning {
            background-color: #fffbf0;
            border-left-color: var(--warning-color);
        }
        .alert-card.alert-high {
            background-color: #fff5f5;
            border-left-color: #cc0000;
        }

        .alert-title {
            font-weight: 600;
            color: var(--danger-color);
        }
        .alert-card.alert-warning .alert-title {
            color: var(--warning-color);
        }
        .alert-card.alert-high .alert-title {
            color: #cc0000;
        }
        .alert-card .alert-icon {
             margin-right: 8px;
        }

        .btn-emergency {
            background-color: var(--danger-color);
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            font-weight: 600;
            color: white;
        }

        .btn-emergency:hover {
            background-color: #d03e27;
        }

        .btn-action {
            background-color: var(--primary-color);
            border: none;
            border-radius: 50px;
            padding: 8px 16px;
            font-weight: 600;
            color: white;
        }

        .btn-action:hover {
            background-color: #0047b3;
            color: white;
        }

        .btn-outline-action {
            border: 1px solid var(--primary-color);
            border-radius: 50px;
            padding: 8px 16px;
            font-weight: 600;
            color: var(--primary-color);
            background-color: white;
        }

        .btn-outline-action:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            z-index: 1000;
        }

        .nav-item { text-align: center; }

        .nav-link {
            color: var(--text-light);
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .nav-link i { font-size: 1.5rem; margin-bottom: 4px; }
        .nav-link.active { color: var(--primary-color); }

        .chart-container { height: 250px; margin: 20px 0; }

        .time-selector { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .time-btn { flex: 1; text-align: center; padding: 8px; background-color: white; border: 1px solid #e0e0e0; color: var(--text-light); font-weight: 500; cursor: pointer; }
        .time-btn:first-child { border-radius: 50px 0 0 50px; }
        .time-btn:last-child { border-radius: 0 50px 50px 0; }
        .time-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }

        .log-item { padding: 15px; border-bottom: 1px solid #f0f0f0; }
        .log-time { font-size: 0.8rem; color: var(--text-light); }
        .log-value { font-weight: 600; font-size: 1.1rem; }
        .log-source { font-size: 0.8rem; padding: 2px 8px; border-radius: 50px; background-color: #e0f0ff; color: var(--primary-color); }

        .modal-content { border-radius: 12px; border: none; }
        .modal-header { border-bottom: 1px solid rgba(0, 0, 0, 0.05); }
        .modal-title { font-weight: 600; }

        .webex-logo { height: 24px; margin-right: 8px; vertical-align: middle; }

        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .loading-container.active {
            display: flex;
        }
        .spinner-border { width: 3rem; height: 3rem; color: var(--primary-color); }
        .loading-text { margin-top: 20px; font-weight: 600; color: var(--primary-color); }
    </style>
</head>
<body>
    <div class="loading-container" id="loadingOverlay">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="loading-text" id="loadingText">로딩 중...</div>
    </div>

    <nav class="navbar navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="static/webex_logo.png" alt="Webex Logo" class="webex-logo">
                pGluc-Webex
            </a>
            <div>
                <button class="btn btn-sm btn-outline-action" id="profileBtn">
                    <i class="bi bi-person-circle"></i> <span id="patientName">환자 이름</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4" id="homeContent">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>현재 혈당</span>
                <span class="log-time" id="lastUpdateTime">최근 업데이트: -</span>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="glucose-value" id="currentGlucoseValue">--</div>
                    <div class="glucose-unit">mg/dL</div>
                    <div class="glucose-trend" id="currentGlucoseTrend">
                        <i class="bi bi-dash"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar" id="glucoseProgressBar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-muted" id="minTargetGlucose">-- mg/dL</small>
                        <small class="text-muted" id="maxTargetGlucose">-- mg/dL</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card prediction-card">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> 혈당 예측
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="prediction-time">30분 후</div>
                        <div class="prediction-value"><span id="predictionValue30">--</span> <span class="glucose-unit">mg/dL</span></div>
                        <div class="glucose-trend" id="predictionTrend30">
                            <i class="bi bi-dash"></i>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="prediction-time">60분 후</div>
                        <div class="prediction-value"><span id="predictionValue60">--</span> <span class="glucose-unit">mg/dL</span></div>
                        <div class="glucose-trend" id="predictionTrend60">
                            <i class="bi bi-dash"></i>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-action" id="viewPredictionBtn">
                        <i class="bi bi-graph-up"></i> 상세 예측 보기
                    </button>
                </div>
            </div>
        </div>

        <div class="d-grid gap-2 mb-4">
            <button class="btn btn-emergency btn-lg" id="emergencyBtn">
                <i class="bi bi-camera-video-fill"></i> 긴급 원격 진료 연결
            </button>
        </div>

        <div id="alertCardContainer">
            <div class="card alert-card alert-warning" style="display: none;" id="alertCardTemplate">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-bell-fill alert-icon"></i>최근 알림</span>
                    <button type="button" class="btn-close" aria-label="Close" onclick="dismissAlert(this)"></button>
                </div>
                <div class="card-body">
                    <h5 class="alert-title">
                        <i class="bi bi-exclamation-triangle alert-icon"></i> <span class="alertTitleText">알림 제목</span>
                    </h5>
                    <p class="alertMessageText">알림 메시지 내용</p>
                    <div class="alert-actions">
                        <button class="btn btn-sm btn-action ack-button">
                            <i class="bi bi-check-circle"></i> 확인 완료
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-clock-history"></i> 최근 기록</span>
                <button class="btn btn-sm btn-outline-action" id="viewAllLogsBtn">
                    모두 보기
                </button>
            </div>
            <div class="card-body p-0" id="recentLogsContainer">
                <div class="log-item text-center text-muted p-3">기록 로딩 중...</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="bi bi-clipboard-data"></i> 상태 입력
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="stateInput" class="form-label">상태</label>
                    <input type="text" class="form-control" id="stateInput" placeholder="예: 정상, 식후">
                </div>
                <div class="mb-3">
                    <label for="mealInput" class="form-label">식사량 (g)</label>
                    <input type="number" class="form-control" id="mealInput" placeholder="예: 50">
                </div>
                <button class="btn btn-action" onclick="submitState()">상태 입력</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-ul"></i> 최근 상태 기록
            </div>
            <div class="card-body p-0" id="stateLogsContainer">
                <div class="log-item text-center text-muted p-3">상태 기록 로딩 중...</div>
            </div>
        </div>
    </div>

    <div class="container mt-4" id="chartContent" style="display: none;">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> 혈당 추세
            </div>
            <div class="card-body">
                <div class="time-selector">
                    <button class="time-btn active" data-hours="3">3시간</button>
                    <button class="time-btn" data-hours="6">6시간</button>
                    <button class="time-btn" data-hours="12">12시간</button>
                    <button class="time-btn" data-hours="24">24시간</button>
                </div>
                <div class="chart-container">
                    <canvas id="glucoseChart"></canvas>
                </div>
                <div class="d-flex justify-content-between mt-3 text-center">
                    <div>
                        <div class="text-muted small">최저 혈당</div>
                        <div class="fw-bold" id="chartMinGlucose">--</div>
                    </div>
                    <div>
                        <div class="text-muted small">평균 혈당</div>
                        <div class="fw-bold" id="chartAvgGlucose">--</div>
                    </div>
                    <div>
                        <div class="text-muted small">최고 혈당</div>
                        <div class="fw-bold" id="chartMaxGlucose">--</div>
                    </div>
                    <div>
                        <div class="text-muted small">목표 범위 (%)</div>
                        <div class="fw-bold" id="chartTargetRange">--%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4" id="logContent" style="display: none;">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-list-ul"></i> 전체 혈당 기록</span>
                <input type="date" id="logDateFilter" class="form-control form-control-sm" style="width: 150px;">
            </div>
            <div class="card-body p-0" id="allLogsContainer">
                <div class="log-item text-center text-muted p-3">기록 로딩 중...</div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav row">
        <div class="col nav-item">
            <a class="nav-link active" href="#" data-target="homeContent">
                <i class="bi bi-house-door-fill"></i>
                홈
            </a>
        </div>
        <div class="col nav-item">
            <a class="nav-link" href="#" data-target="chartContent">
                <i class="bi bi-graph-up"></i>
                차트
            </a>
        </div>
        <div class="col nav-item">
            <a class="nav-link" href="#" data-target="logContent">
                <i class="bi bi-list-ul"></i>
                기록
            </a>
        </div>
        <div class="col nav-item">
            <a class="nav-link" href="#" id="settingsBtn">
                <i class="bi bi-gear"></i>
                설정
            </a>
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const patientId = 'kimjaehoug';
        const backendUrl = 'https://cisco-ejsn.vercel.app';
        let glucoseChartInstance = null;
        let currentPatientData = {};
        let currentChartHours = 3;

        // --- DOM 요소 ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const patientNameEl = document.getElementById('patientName');
        const lastUpdateTimeEl = document.getElementById('lastUpdateTime');
        const currentGlucoseValueEl = document.getElementById('currentGlucoseValue');
        const currentGlucoseTrendEl = document.getElementById('currentGlucoseTrend');
        const glucoseProgressBarEl = document.getElementById('glucoseProgressBar');
        const minTargetGlucoseEl = document.getElementById('minTargetGlucose');
        const maxTargetGlucoseEl = document.getElementById('maxTargetGlucose');
        const predictionValue30El = document.getElementById('predictionValue30');
        const predictionTrend30El = document.getElementById('predictionTrend30');
        const predictionValue60El = document.getElementById('predictionValue60');
        const predictionTrend60El = document.getElementById('predictionTrend60');
        const alertCardContainerEl = document.getElementById('alertCardContainer');
        const alertCardTemplateEl = document.getElementById('alertCardTemplate');
        const recentLogsContainerEl = document.getElementById('recentLogsContainer');
        const allLogsContainerEl = document.getElementById('allLogsContainer');
        const logDateFilterEl = document.getElementById('logDateFilter');
        const stateLogsContainerEl = document.getElementById('stateLogsContainer');

        const homeContent = document.getElementById('homeContent');
        const chartContent = document.getElementById('chartContent');
        const logContent = document.getElementById('logContent');
        const bottomNavLinks = document.querySelectorAll('.bottom-nav .nav-link');
        const timeSelectorBtns = document.querySelectorAll('.time-selector .time-btn');

        // --- 로딩 함수 ---
        function showLoading(message = '로딩 중...') {
            loadingText.innerText = message;
            loadingOverlay.classList.add('active');
        }
        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }

        // --- 트렌드 아이콘 및 클래스 반환 함수 ---
        function getTrendInfo(currentValue, previousValue) {
            if (previousValue === null || previousValue === undefined || currentValue === previousValue) {
                return { icon: 'bi-dash', class: 'trend-stable', change: 0 };
            }
            const diff = currentValue - previousValue;
            if (diff > 5) return { icon: 'bi-arrow-up', class: 'trend-up', change: diff };
            if (diff < -5) return { icon: 'bi-arrow-down', class: 'trend-down', change: diff };
            return { icon: 'bi-arrow-right', class: 'trend-stable', change: diff };
        }

        // --- UI 업데이트 함수 ---
        function updatePatientInfoUI(patientData) {
            currentPatientData = patientData;
            patientNameEl.innerText = patientData.name || '환자 정보 없음';
            if (patientData.target_glucose_range) {
                minTargetGlucoseEl.innerText = `${patientData.target_glucose_range.min} mg/dL`;
                maxTargetGlucoseEl.innerText = `${patientData.target_glucose_range.max} mg/dL`;
            }
        }

        function updatePredictionUI(predictions) {
            if (!predictions || predictions.length < 3) {
                console.warn("Invalid prediction data received");
                currentGlucoseValueEl.innerText = '데이터 없음';
                predictionValue30El.innerText = '데이터 없음';
                predictionValue60El.innerText = '데이터 없음';
                return;
            }
            const sortedPredictions = predictions.slice().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const currentVal = sortedPredictions[0].value;
            const pred30Val = sortedPredictions[1].value;
            const pred60Val = sortedPredictions[2].value;

            currentGlucoseValueEl.innerText = currentVal;
            predictionValue30El.innerText = pred30Val;
            predictionValue60El.innerText = pred60Val;

            if (sortedPredictions[0].timestamp) {
                lastUpdateTimeEl.innerText = `업데이트: ${moment(sortedPredictions[0].timestamp).fromNow()}`;
            }

            const trendInfoCurrent = getTrendInfo(currentVal, null);
            currentGlucoseTrendEl.innerHTML = `<i class="bi ${trendInfoCurrent.icon}"></i>`;
            currentGlucoseTrendEl.className = `glucose-trend ${trendInfoCurrent.class}`;

            const trendInfo30 = getTrendInfo(pred30Val, currentVal);
            predictionTrend30El.innerHTML = `<i class="bi ${trendInfo30.icon}"></i> ${trendInfo30.change >= 0 ? '+' : ''}${trendInfo30.change}`;
            predictionTrend30El.className = `glucose-trend ${trendInfo30.class}`;

            const trendInfo60 = getTrendInfo(pred60Val, pred30Val);
            predictionTrend60El.innerHTML = `<i class="bi ${trendInfo60.icon}"></i> ${trendInfo60.change >= 0 ? '+' : ''}${trendInfo60.change}`;
            predictionTrend60El.className = `glucose-trend ${trendInfo60.class}`;

            if (currentPatientData.target_glucose_range) {
                const minTarget = currentPatientData.target_glucose_range.min;
                const maxTarget = currentPatientData.target_glucose_range.max;
                let progressPercent = ((currentVal - 40) / (260)) * 100;
                progressPercent = Math.max(0, Math.min(100, progressPercent));

                glucoseProgressBarEl.style.width = `${progressPercent}%`;
                glucoseProgressBarEl.classList.remove('bg-success', 'bg-warning', 'bg-danger');
                if (currentVal < minTarget) {
                    glucoseProgressBarEl.classList.add('bg-warning');
                } else if (currentVal > maxTarget) {
                    glucoseProgressBarEl.classList.add('bg-danger');
                } else {
                    glucoseProgressBarEl.classList.add('bg-success');
                }
            }
        }

        function updateAlertUI(alerts) {
            alertCardContainerEl.innerHTML = '';
            if (alerts && alerts.length > 0) {
                const latestAlert = alerts[0];
                const alertCard = alertCardTemplateEl.cloneNode(true);
                alertCard.style.display = 'block';
                alertCard.id = `alert-${latestAlert.id}`;

                const titleText = alertCard.querySelector('.alertTitleText');
                const messageText = alertCard.querySelector('.alertMessageText');
                const alertIcon = alertCard.querySelectorAll('.alert-icon');

                alertCard.classList.remove('alert-warning', 'alert-danger', 'alert-high');
                let titlePrefix = '';
                let iconClass = '';

                if (latestAlert.type === 'low') {
                    alertCard.classList.add('alert-warning');
                    titlePrefix = '저혈당 위험 감지';
                    iconClass = 'bi-exclamation-triangle-fill';
                } else if (latestAlert.type === 'high') {
                    alertCard.classList.add('alert-high');
                    titlePrefix = '고혈당 위험 감지';
                    iconClass = 'bi-exclamation-octagon-fill';
                } else {
                    alertCard.classList.add('alert-secondary');
                    titlePrefix = '알림';
                    iconClass = 'bi-info-circle-fill';
                }

                titleText.innerText = titlePrefix;
                messageText.innerText = latestAlert.message || '상세 정보 없음';
                alertIcon.forEach(icon => {
                    icon.className = `alert-icon bi ${iconClass}`;
                });

                const ackButton = alertCard.querySelector('.ack-button');
                ackButton.onclick = () => acknowledgeAlert(latestAlert.id);

                alertCardContainerEl.appendChild(alertCard);
            }
        }

        async function acknowledgeAlert(alertId) {
            console.log(`알림 확인 시도: ${alertId}`);
            showLoading('알림 확인 중...');
            try {
                const response = await fetch(`${backendUrl}/api/patients/${patientId}/alerts/${alertId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ acknowledged: true, status: 'acknowledged' })
                });
                if (response.ok || response.status === 304) {
                    console.log(`알림 확인 완료: ${alertId}`);
                    const alertCard = document.getElementById(`alert-${alertId}`);
                    if (alertCard) {
                        alertCard.style.opacity = '0.5';
                        alertCard.querySelector('.ack-button').disabled = true;
                        alertCard.querySelector('.ack-button').innerText = '확인됨';
                        setTimeout(() => alertCard.remove(), 1000);
                    }
                } else {
                    const errorResult = await response.json();
                    alert(`알림 확인 실패: ${errorResult.error}`);
                }
            } catch (error) {
                console.error('알림 확인 오류:', error);
                alert('알림 확인 중 오류 발생');
            } finally {
                hideLoading();
            }
        }

        function dismissAlert(closeButton) {
            const card = closeButton.closest('.alert-card');
            if (card) {
                card.remove();
            }
        }

        function updateRecentLogsUI(readings) {
            recentLogsContainerEl.innerHTML = '';
            if (!readings || readings.length === 0) {
                recentLogsContainerEl.innerHTML = '<div class="log-item text-center text-muted p-3">최근 기록이 없습니다.</div>';
                return;
            }

            const recentReadings = readings.slice().reverse().slice(0, 3);
            recentReadings.forEach(reading => {
                const logDiv = document.createElement('div');
                logDiv.className = 'log-item d-flex justify-content-between align-items-center';
                logDiv.innerHTML = `
                    <div>
                        <div class="log-time">${moment(reading.timestamp).format('HH:mm')}</div>
                        <div class="log-value">${reading.glucose} mg/dL</div>
                    </div>
                    <span class="log-source">${reading.source || 'CGM'}</span>
                `;
                recentLogsContainerEl.appendChild(logDiv);
            });
        }

        function updateAllLogsUI(readings) {
            allLogsContainerEl.innerHTML = '';
            if (!readings || readings.length === 0) {
                allLogsContainerEl.innerHTML = '<div class="log-item text-center text-muted p-3">선택된 날짜의 기록이 없습니다.</div>';
                return;
            }

            readings.slice().reverse().forEach(reading => {
                const logDiv = document.createElement('div');
                logDiv.className = 'log-item d-flex justify-content-between align-items-center';
                logDiv.innerHTML = `
                    <div>
                        <div class="log-time">${moment(reading.timestamp).format('YYYY-MM-DD HH:mm')}</div>
                        <div class="log-value">${reading.glucose} mg/dL</div>
                    </div>
                    <span class="log-source">${reading.source || 'CGM'}</span>
                `;
                allLogsContainerEl.appendChild(logDiv);
            });
        }

        function updateStateLogsUI(states) {
            stateLogsContainerEl.innerHTML = '';
            if (!states || states.length === 0) {
                stateLogsContainerEl.innerHTML = '<div class="log-item text-center text-muted p-3">최근 상태 기록이 없습니다.</div>';
                return;
            }

            states.slice().reverse().forEach(state => {
                const logDiv = document.createElement('div');
                logDiv.className = 'log-item d-flex justify-content-between align-items-center';
                logDiv.innerHTML = `
                    <div>
                        <div class="log-time">${moment(state.time).format('YYYY-MM-DD HH:mm')}</div>
                        <div class="log-value">${state.state}</div>
                    </div>
                    <span class="log-source">식사량: ${state.meal}g</span>
                `;
                stateLogsContainerEl.appendChild(logDiv);
            });
        }

        function updateChart(readings, hours = 3) {
            if (!readings || readings.length === 0) {
                console.warn("차트에 표시할 데이터가 없습니다.");
                if (glucoseChartInstance) {
                    glucoseChartInstance.destroy();
                    glucoseChartInstance = null;
                    document.getElementById('chartMinGlucose').innerText = '--';
                    document.getElementById('chartAvgGlucose').innerText = '--';
                    document.getElementById('chartMaxGlucose').innerText = '--';
                    document.getElementById('chartTargetRange').innerText = '--%';
                }
                return;
            }

            const ctx = document.getElementById('glucoseChart').getContext('2d');
            const labels = readings.map(r => r.timestamp);
            const dataPoints = readings.map(r => r.glucose);

            const values = dataPoints.filter(v => v !== null && v !== undefined);
            const minVal = values.length > 0 ? Math.min(...values) : null;
            const maxVal = values.length > 0 ? Math.max(...values) : null;
            const avgVal = values.length > 0 ? Math.round(values.reduce((a, b) => a + b, 0) / values.length) : null;

            let inRangeCount = 0;
            const minTarget = currentPatientData.target_glucose_range?.min || 70;
            const maxTarget = currentPatientData.target_glucose_range?.max || 180;
            if (values.length > 0) {
                inRangeCount = values.filter(v => v >= minTarget && v <= maxTarget).length;
            }
            const targetRangePercent = values.length > 0 ? Math.round((inRangeCount / values.length) * 100) : 0;

            document.getElementById('chartMinGlucose').innerText = minVal !== null ? `${minVal} mg/dL` : '--';
            document.getElementById('chartAvgGlucose').innerText = avgVal !== null ? `${avgVal} mg/dL` : '--';
            document.getElementById('chartMaxGlucose').innerText = maxVal !== null ? `${maxVal} mg/dL` : '--';
            document.getElementById('chartTargetRange').innerText = `${targetRangePercent}%`;

            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: '혈당 (mg/dL)',
                        data: dataPoints,
                        borderColor: 'rgb(0, 82, 204)',
                        backgroundColor: 'rgba(0, 82, 204, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 1,
                        pointHoverRadius: 5
                    },
                    {
                        label: '예측 혈당 (mg/dL)',
                        data: [],
                        borderColor: 'rgb(255, 165, 0)',
                        borderWidth: 1.5,
                        borderDash: [10, 10],
                        pointRadius: 0,
                        fill: false
                    }
                ]
            };

            async function fetchPredictionsForChart() {
                try {
                    const response = await fetch(`${backendUrl}/api/patients/${patientId}/predictions`);
                    if (!response.ok) throw new Error(`예측 데이터 조회 실패: ${response.status}`);
                    const data = await response.json();
                    const predictions = data.predictions.map(p => ({
                        x: p.timestamp,
                        y: p.value
                    }));
                    chartData.datasets[1].data = predictions;
                    if (glucoseChartInstance) {
                        glucoseChartInstance.data = chartData;
                        glucoseChartInstance.update();
                    }
                } catch (error) {
                    console.error('예측 데이터 조회 오류:', error);
                }
            }

            fetchPredictionsForChart();

            const config = {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: hours <= 6 ? 'hour' : 'day',
                                displayFormats: {
                                    hour: 'HH:mm',
                                    day: 'MM/DD'
                                }
                            },
                            title: { display: true, text: '시간' }
                        },
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: '혈당 (mg/dL)' },
                            suggestedMin: 40,
                            suggestedMax: 250
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: minTarget,
                                    yMax: minTarget,
                                    borderColor: 'rgba(247, 168, 0, 0.5)',
                                    borderWidth: 1,
                                    borderDash: [5, 5],
                                    label: { content: `저혈당 경계 (${minTarget})`, enabled: true, position: 'start', font: {size: 10} }
                                },
                                line2: {
                                    type: 'line',
                                    yMin: maxTarget,
                                    yMax: maxTarget,
                                    borderColor: 'rgba(233, 79, 55, 0.5)',
                                    borderWidth: 1,
                                    borderDash: [5, 5],
                                    label: { content: `고혈당 경계 (${maxTarget})`, enabled: true, position: 'start', font: {size: 10} }
                                }
                            }
                        }
                    }
                }
            };

            if (glucoseChartInstance) {
                glucoseChartInstance.destroy();
            }
            glucoseChartInstance = new Chart(ctx, config);
        }

        async function fetchData(hours = 3) {
            showLoading('데이터 로딩 중...');
            let predictionData = null;
            let alertData = null;
            let glucoseData = null;
            let patientData = null;
            let stateData = null;

            try {
                const [patientRes, predictionRes, alertRes, glucoseRes, stateRes] = await Promise.all([
                    fetch(`${backendUrl}/api/patients/${patientId}`).catch(err => { console.error('환자 데이터 오류:', err); return null; }),
                    fetch(`${backendUrl}/api/patients/${patientId}/predictions`).catch(err => { console.error('예측 데이터 오류:', err); return null; }),
                    fetch(`${backendUrl}/api/patients/${patientId}/alerts?active_only=true`).catch(err => { console.error('알림 데이터 오류:', err); return null; }),
                    fetch(`${backendUrl}/api/patients/${patientId}/glucose`).catch(err => { console.error('혈당 데이터 오류:', err); return null; }),
                    fetch(`${backendUrl}/api/patients/${patientId}/states`).catch(err => { console.error('상태 데이터 오류:', err); return null; })
                ]);

                if (patientRes && patientRes.ok) patientData = await patientRes.json();
                if (predictionRes && predictionRes.ok) predictionData = await predictionRes.json();
                if (alertRes && alertRes.ok) alertData = await alertRes.json();
                if (glucoseRes && glucoseRes.ok) glucoseData = await glucoseRes.json();
                if (stateRes && stateRes.ok) stateData = await stateRes.json();

                if (!patientData || !glucoseData || !predictionData) {
                    // 데이터가 없으면 SeedDemoData 호출
                    console.log('데이터가 없어 SeedDemoData 호출 시도');
                    const seedResponse = await fetch(`${backendUrl}/api/seed_demo_data`, { method: 'POST' });
                    if (seedResponse.ok) {
                        console.log('SeedDemoData 성공, 데이터 다시 로드');
                        await fetchData(hours); // 다시 로드
                        return;
                    } else {
                        throw new Error('SeedDemoData 호출 실패');
                    }
                }

                if (patientData) updatePatientInfoUI(patientData);
                if (predictionData) updatePredictionUI(predictionData.predictions);
                if (alertData) updateAlertUI(alertData.alerts);
                if (glucoseData) updateRecentLogsUI(glucoseData.readings);
                if (glucoseData) updateChart(glucoseData.readings, hours);
                if (stateData) updateStateLogsUI(stateData.states);

            } catch (error) {
                console.error('데이터 로딩 오류:', error);
                alert('데이터를 불러오는 중 오류가 발생했습니다. 관리자에게 문의하세요.');
                currentGlucoseValueEl.innerText = '오류';
                predictionValue30El.innerText = '오류';
                predictionValue60El.innerText = '오류';
                recentLogsContainerEl.innerHTML = '<div class="log-item text-center text-danger p-3">데이터 로드 실패</div>';
                stateLogsContainerEl.innerHTML = '<div class="log-item text-center text-danger p-3">상태 데이터 로드 실패</div>';
                if (glucoseChartInstance) {
                    glucoseChartInstance.destroy();
                    glucoseChartInstance = null;
                }
            } finally {
                hideLoading();
            }
        }

        async function fetchAllLogs(dateStr) {
    showLoading('전체 기록 로딩 중...');
    try {
        const response = await fetch(`${backendUrl}/api/patients/${patientId}/glucose`);
        if (response.ok) {
            const data = await response.json();
            const readings = Array.isArray(data.readings) ? data.readings : [];
            console.log(readings);
            const filteredReadings = readings.filter(r => r.timestamp?.startsWith(dateStr));
            updateAllLogsUI(filteredReadings);
        } else {
            throw new Error('Failed to load logs');
        }
    } catch (error) {
        console.error("전체 기록 로딩 오류:", error);
        allLogsContainerEl.innerHTML = '<div class="log-item text-center text-danger p-3">기록 로드 실패</div>';
    } finally {
        hideLoading();
    }
}

        async function submitState() {
            const state = document.getElementById('stateInput').value;
            const meal = parseInt(document.getElementById('mealInput').value);
            if (!state || isNaN(meal)) {
                alert('상태와 식사량을 입력하세요.');
                return;
            }

            showLoading('상태 입력 중...');
            try {
                const response = await fetch(`${backendUrl}/api/patients/${patientId}/states`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ state, meal })
                });
                if (response.ok) {
                    document.getElementById('stateInput').value = '';
                    document.getElementById('mealInput').value = '';
                    fetchData(currentChartHours);
                } else {
                    const errorResult = await response.json();
                    alert(`상태 입력 실패: ${errorResult.error}`);
                }
            } catch (error) {
                console.error('상태 입력 오류:', error);
                alert('상태 입력 중 오류 발생');
            } finally {
                hideLoading();
            }
        }

        // --- 이벤트 리스너 ---
        document.getElementById('emergencyBtn').addEventListener('click', async () => {
            if (!confirm('긴급 원격 진료를 연결하시겠습니까? 담당 의사에게 알림이 갑니다.')) {
                return;
            }

            showLoading('긴급 연결 요청 중...');
            try {
                const response = await fetch(`${backendUrl}/api/webex/emergency_connect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ patient_id: patientId }),
                });
                const result = await response.json();
                hideLoading();

                if (response.ok) {
                    alert(`긴급 연결 요청 성공! 의사가 곧 연결할 것입니다. 참여 URL(참고용): ${result.joinUrl || result.id}`);
                } else {
                    alert(`긴급 연결 실패: ${result.error || '알 수 없는 오류'}`);
                }
            } catch (error) {
                hideLoading();
                console.error('긴급 연결 요청 오류:', error);
                alert('긴급 연결 요청 중 오류가 발생했습니다.');
            }
        });

        bottomNavLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const targetId = link.getAttribute('data-target');

                if (!targetId) return;

                homeContent.style.display = 'none';
                chartContent.style.display = 'none';
                logContent.style.display = 'none';

                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    targetElement.style.display = 'block';
                }

                bottomNavLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                if (targetId === 'logContent') {
                    const today = new Date().toISOString().split('T')[0];
                    logDateFilterEl.value = today;
                    fetchAllLogs(today);
                } else if (targetId === 'chartContent') {
                    fetchData(currentChartHours);
                } else if (targetId === 'homeContent') {
                    fetchData(3);
                }
            });
        });

        timeSelectorBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                timeSelectorBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentChartHours = parseInt(btn.getAttribute('data-hours'));
                fetchData(currentChartHours);
            });
        });

        logDateFilterEl.addEventListener('change', (event) => {
            fetchAllLogs(event.target.value);
        });

        document.getElementById('viewPredictionBtn').addEventListener('click', () => {
            document.querySelector('.nav-link[data-target="chartContent"]').click();
        });

        document.getElementById('viewAllLogsBtn').addEventListener('click', () => {
            document.querySelector('.nav-link[data-target="logContent"]').click();
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchData(currentChartHours);
            setInterval(() => {
                const activeLink = document.querySelector('.bottom-nav .nav-link.active');
                const activeTarget = activeLink ? activeLink.getAttribute('data-target') : 'homeContent';
                let hoursToFetch = 3;
                if (activeTarget === 'chartContent') {
                    hoursToFetch = currentChartHours;
                } else if (activeTarget === 'logContent') {
                    return;
                }
                fetchData(hoursToFetch);
            }, 30000);
        });
    </script>
</body>
</html>
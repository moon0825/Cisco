<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pGluc-Webex ëª¨ë°”ì¼ ì•± í”„ë¡œí† íƒ€ì…</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-timezone@0.5.40/builds/moment-timezone-with-data.min.js"></script>

    <style>
        /* CSS ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ */
        :root {
            --primary-color: #0052cc; --secondary-color: #00a0d1;
            --danger-color: #e94f37; --warning-color: #f7a800;
            --success-color: #36b37e; --bg-light: #f5f7fa;
            --text-dark: #253858; --text-light: #6b778c;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-light); color: var(--text-dark); padding-bottom: 70px; }
        .navbar-brand { font-weight: 700; color: var(--primary-color); }
        .navbar { background-color: white; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .card { border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); margin-bottom: 20px; border: none; }
        .card-header { background-color: white; border-bottom: 1px solid rgba(0, 0, 0, 0.05); font-weight: 600; padding: 15px 20px; }
        .glucose-value { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); }
        .glucose-unit { font-size: 1rem; color: var(--text-light); }
        .glucose-trend { font-size: 1.2rem; margin-left: 10px; }
        .trend-up { color: var(--danger-color); } .trend-down { color: var(--warning-color); } .trend-stable { color: var(--success-color); }
        .prediction-card { background-color: #f0f7ff; border-left: 4px solid var(--primary-color); }
        .prediction-value { font-size: 1.8rem; font-weight: 600; }
        .prediction-time { font-size: 0.9rem; color: var(--text-light); }
        #alertCardContainer { margin-bottom: 20px; }
        .alert-card { border-left-width: 4px; border-left-style: solid; background-color: #fff8f8; border-left-color: var(--danger-color); }
        .alert-card.alert-warning { background-color: #fffbf0; border-left-color: var(--warning-color); }
        .alert-card.alert-high { background-color: #fff5f5; border-left-color: #cc0000; }
        .alert-title { font-weight: 600; color: var(--danger-color); }
        .alert-card.alert-warning .alert-title { color: var(--warning-color); }
        .alert-card.alert-high .alert-title { color: #cc0000; }
        .alert-card .alert-icon { margin-right: 8px; }
        .btn-emergency { background-color: var(--danger-color); border: none; border-radius: 50px; padding: 10px 20px; font-weight: 600; color: white; }
        .btn-emergency:hover { background-color: #d03e27; }
        .btn-action { background-color: var(--primary-color); border: none; border-radius: 50px; padding: 8px 16px; font-weight: 600; color: white; }
        .btn-action:hover { background-color: #0047b3; color: white; }
        .btn-outline-action { border: 1px solid var(--primary-color); border-radius: 50px; padding: 8px 16px; font-weight: 600; color: var(--primary-color); background-color: white; }
        .btn-outline-action:hover { background-color: var(--primary-color); color: white; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background-color: white; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; z-index: 1000; }
        .nav-item { text-align: center; }
        .nav-link { color: var(--text-light); font-size: 0.8rem; display: flex; flex-direction: column; align-items: center; }
        .nav-link i { font-size: 1.5rem; margin-bottom: 4px; }
        .nav-link.active { color: var(--primary-color); }
        .chart-container { height: 250px; margin: 20px 0; }
        .time-selector { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .time-btn { flex: 1; text-align: center; padding: 8px; background-color: white; border: 1px solid #e0e0e0; color: var(--text-light); font-weight: 500; cursor: pointer; }
        .time-btn:first-child { border-radius: 50px 0 0 50px; } .time-btn:last-child { border-radius: 0 50px 50px 0; }
        .time-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .log-item { padding: 15px; border-bottom: 1px solid #f0f0f0; }
        .log-time { font-size: 0.8rem; color: var(--text-light); }
        .log-value { font-weight: 600; font-size: 1.1rem; }
        .log-source { font-size: 0.8rem; padding: 2px 8px; border-radius: 50px; background-color: #e0f0ff; color: var(--primary-color); }
        .webex-logo { height: 24px; margin-right: 8px; vertical-align: middle; }
        .loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .loading-container.active { display: flex; }
        .spinner-border { width: 3rem; height: 3rem; color: var(--primary-color); }
        .loading-text { margin-top: 20px; font-weight: 600; color: var(--primary-color); }
    </style>
</head>
<body>
    <div class="loading-container" id="loadingOverlay">
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        <div class="loading-text" id="loadingText">ë¡œë”© ì¤‘...</div>
    </div>

    <nav class="navbar navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#"><img src="/static/webex_logo.png" alt="Webex Logo" class="webex-logo">pGluc-Webex</a>
            <div><button class="btn btn-sm btn-outline-action" id="profileBtn"><i class="bi bi-person-circle"></i> <span id="patientName">í™˜ì ì´ë¦„</span></button></div>
        </div>
    </nav>

    <div class="container mt-4" id="homeContent">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>í˜„ì¬ í˜ˆë‹¹</span><span class="log-time" id="lastUpdateTime">ìµœê·¼ ì—…ë°ì´íŠ¸: -</span>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="glucose-value" id="currentGlucoseValue">--</div>
                    <div class="glucose-unit">mg/dL</div>
                    <div class="glucose-trend" id="currentGlucoseTrend"><i class="bi bi-dash"></i></div>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height: 8px;"><div class="progress-bar" id="glucoseProgressBar" role="progressbar" style="width: 0%;"></div></div>
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-muted" id="minTargetGlucose">-- mg/dL</small><small class="text-muted" id="maxTargetGlucose">-- mg/dL</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card prediction-card">
            <div class="card-header"><i class="bi bi-graph-up"></i> í˜ˆë‹¹ ì˜ˆì¸¡</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="prediction-time">30ë¶„ í›„</div>
                        <div class="prediction-value"><span id="predictionValue30">--</span> <span class="glucose-unit">mg/dL</span></div>
                        <div class="glucose-trend" id="predictionTrend30"><i class="bi bi-dash"></i></div>
                    </div>
                    <div class="col-6">
                        <div class="prediction-time">60ë¶„ í›„</div>
                        <div class="prediction-value"><span id="predictionValue60">--</span> <span class="glucose-unit">mg/dL</span></div>
                        <div class="glucose-trend" id="predictionTrend60">
                            <i class="bi bi-dash"></i>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-action" id="viewPredictionBtn">
                        <i class="bi bi-graph-up"></i> ìƒì„¸ ì˜ˆì¸¡ ë³´ê¸°
                    </button>
                </div>
            </div>
        </div>

        <div class="d-grid gap-2 mb-4">
            <button class="btn btn-emergency btn-lg" id="emergencyBtn"><i class="bi bi-camera-video-fill"></i> ê¸´ê¸‰ ì›ê²© ì§„ë£Œ ì—°ê²°</button>
        </div>

        <div id="alertCardContainer">
            <div class="card alert-card alert-warning" style="display: none;" id="alertCardTemplate">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-bell-fill alert-icon"></i>ìµœê·¼ ì•Œë¦¼</span>
                    <button type="button" class="btn-close" aria-label="Close" onclick="dismissAlert(this)"></button>
                </div>
                <div class="card-body">
                    <h5 class="alert-title"><i class="bi bi-exclamation-triangle alert-icon"></i> <span class="alertTitleText">ì•Œë¦¼ ì œëª©</span></h5>
                    <p class="alertMessageText">ì•Œë¦¼ ë©”ì‹œì§€ ë‚´ìš©</p>
                    <div class="alert-actions"><button class="btn btn-sm btn-action ack-button"><i class="bi bi-check-circle"></i> í™•ì¸ ì™„ë£Œ</button></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-clock-history"></i> ìµœê·¼ ê¸°ë¡</span>
                <button class="btn btn-sm btn-outline-action" id="viewAllLogsBtn">ëª¨ë‘ ë³´ê¸°</button>
            </div>
            <div class="card-body p-0" id="recentLogsContainer"><div class="log-item text-center text-muted p-3">ê¸°ë¡ ë¡œë”© ì¤‘...</div></div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="bi bi-clipboard-data"></i> ìƒíƒœ ì…ë ¥
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="stateInput" class="form-label">ìƒíƒœ</label>
                    <input type="text" class="form-control" id="stateInput" placeholder="ì˜ˆ: ì‹ì‚¬, ìš´ë™">
                </div>
                <div class="mb-3">
                    <label for="mealInput" class="form-label">ì¹¼ë¡œë¦¬ (kcal)</label>
                    <input type="number" class="form-control" id="mealInput" placeholder="ì˜ˆ: 50">
                </div>
                <button class="btn btn-action" onclick="submitState()">ìƒíƒœ ì…ë ¥</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-ul"></i> ìµœê·¼ ìƒíƒœ ê¸°ë¡
            </div>
            <div class="card-body p-0" id="stateLogsContainer">
                <div class="log-item text-center text-muted p-3">ìƒíƒœ ê¸°ë¡ ë¡œë”© ì¤‘...</div>
            </div>
        </div>
    </div>

    <div class="container mt-4" id="chartContent" style="display: none;">
        <div class="card">
            <div class="card-header"><i class="bi bi-graph-up"></i> í˜ˆë‹¹ ì¶”ì„¸</div>
            <div class="card-body">
                <div class="time-selector">
                    <button class="time-btn active" data-hours="3">3ì‹œê°„</button>
                    <button class="time-btn" data-hours="6">6ì‹œê°„</button>
                    <button class="time-btn" data-hours="12">12ì‹œê°„</button>
                    <button class="time-btn" data-hours="24">24ì‹œê°„</button>
                </div>
                <div class="chart-container"><canvas id="glucoseChart"></canvas></div>
                <div class="d-flex justify-content-between mt-3 text-center">
                    <div><div class="text-muted small">ìµœì € í˜ˆë‹¹</div><div class="fw-bold" id="chartMinGlucose">--</div></div>
                    <div><div class="text-muted small">í‰ê·  í˜ˆë‹¹</div><div class="fw-bold" id="chartAvgGlucose">--</div></div>
                    <div><div class="text-muted small">ìµœê³  í˜ˆë‹¹</div><div class="fw-bold" id="chartMaxGlucose">--</div></div>
                    <div><div class="text-muted small">ëª©í‘œ ë²”ìœ„ (%)</div><div class="fw-bold" id="chartTargetRange">--%</div></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4" id="logContent" style="display: none;">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-list-ul"></i> ì „ì²´ í˜ˆë‹¹ ê¸°ë¡</span>
                <input type="date" id="logDateFilter" class="form-control form-control-sm" style="width: 150px;">
            </div>
            <div class="card-body p-0" id="allLogsContainer"><div class="log-item text-center text-muted p-3">ê¸°ë¡ ë¡œë”© ì¤‘...</div></div>
        </div>
    </div>

    <nav class="bottom-nav row">
        <div class="col nav-item"><a class="nav-link active" href="#" data-target="homeContent"><i class="bi bi-house-door-fill"></i>í™ˆ</a></div>
        <div class="col nav-item"><a class="nav-link" href="#" data-target="chartContent"><i class="bi bi-graph-up"></i>ì°¨íŠ¸</a></div>
        <div class="col nav-item"><a class="nav-link" href="#" data-target="logContent"><i class="bi bi-list-ul"></i>ê¸°ë¡</a></div>
        <div class="col nav-item"><a class="nav-link" href="#" id="settingsBtn"><i class="bi bi-gear"></i>ì„¤ì •</a></div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- ì„¤ì • ---
        const patientId = 'kimjaehoug'; // í™˜ì ID ì„¤ì • (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ë¡œê·¸ì¸ í†µí•´ ë°›ì•„ì™€ì•¼ í•¨)
        const backendUrl = 'http://10.55.56.37:5371'; // ë°°í¬ëœ ë°±ì—”ë“œ URL
        let glucoseChartInstance = null;
        let currentPatientData = {};
        let currentChartHours = 3; // ì°¨íŠ¸ ê¸°ë³¸ ì‹œê°„ ë²”ìœ„

        // --- DOM ìš”ì†Œ ìºì‹± ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const patientNameEl = document.getElementById('patientName');
        const lastUpdateTimeEl = document.getElementById('lastUpdateTime');
        const currentGlucoseValueEl = document.getElementById('currentGlucoseValue');
        const currentGlucoseTrendEl = document.getElementById('currentGlucoseTrend');
        const glucoseProgressBarEl = document.getElementById('glucoseProgressBar');
        const minTargetGlucoseEl = document.getElementById('minTargetGlucose');
        const maxTargetGlucoseEl = document.getElementById('maxTargetGlucose');
        const predictionValue30El = document.getElementById('predictionValue30');
        const predictionTrend30El = document.getElementById('predictionTrend30');
        const predictionValue60El = document.getElementById('predictionValue60');
        const predictionTrend60El = document.getElementById('predictionTrend60');
        const alertCardContainerEl = document.getElementById('alertCardContainer');
        const alertCardTemplateEl = document.getElementById('alertCardTemplate');
        const recentLogsContainerEl = document.getElementById('recentLogsContainer');
        const allLogsContainerEl = document.getElementById('allLogsContainer');
        const logDateFilterEl = document.getElementById('logDateFilter');
        const stateLogsContainerEl = document.getElementById('stateLogsContainer'); // ìƒíƒœ ê¸°ë¡ ì œê±°

        const homeContent = document.getElementById('homeContent');
        const chartContent = document.getElementById('chartContent');
        const logContent = document.getElementById('logContent');
        const bottomNavLinks = document.querySelectorAll('.bottom-nav .nav-link');
        const timeSelectorBtns = document.querySelectorAll('.time-selector .time-btn');

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function showLoading(message = 'ë¡œë”© ì¤‘...') {
            loadingText.innerText = message; loadingOverlay.classList.add('active');
        }
        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }
        function getTrendInfo(currentValue, previousValue) {
            if (previousValue == null || currentValue == null || currentValue == previousValue) {
                return { icon: 'bi-dash', class: 'trend-stable', change: 0 };
            }
            const diff = currentValue - previousValue;
            if (diff > 5) return { icon: 'bi-arrow-up', class: 'trend-up', change: diff.toFixed(2) };
            if (diff < -5) return { icon: 'bi-arrow-down', class: 'trend-down', change: diff.toFixed(2) };
            return { icon: 'bi-arrow-right', class: 'trend-stable', change: diff.toFixed(2) };
        }

        // --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        function updatePatientInfoUI(patientData) {
             if (!patientData) return;
             currentPatientData = patientData;
             patientNameEl.innerText = patientData.name || 'í™˜ì ì •ë³´ ì—†ìŒ';
             if (patientData.target_glucose_range) {
                minTargetGlucoseEl.innerText = `${patientData.target_glucose_range.min} mg/dL`;
                maxTargetGlucoseEl.innerText = `${patientData.target_glucose_range.max} mg/dL`;
             } else {
                 minTargetGlucoseEl.innerText = '-- mg/dL';
                 maxTargetGlucoseEl.innerText = '-- mg/dL';
             }
        }

        function updatePredictionUI(predictionData) {
    if (!Array.isArray(predictionData) || predictionData.length < 3) {
        console.warn("ìœ íš¨í•˜ì§€ ì•Šì€ ì˜ˆì¸¡ ë°ì´í„°", predictionData);
        currentGlucoseValueEl.innerText = 'N/A';
        predictionValue30El.innerText = 'N/A';
        predictionValue60El.innerText = 'N/A';
        lastUpdateTimeEl.innerText = 'ì—…ë°ì´íŠ¸: -';
        [currentGlucoseTrendEl, predictionTrend30El, predictionTrend60El].forEach(el => {
            el.innerHTML = '<i class="bi bi-question-circle"></i>';
            el.className = 'glucose-trend';
        });
        glucoseProgressBarEl.style.width = '0%';
        glucoseProgressBarEl.className = 'progress-bar';
        return;
    }

    // ì •ë ¬ëœ ì˜ˆì¸¡ê°’ 3ê°œ ì¶”ì¶œ
    const sortedPredictions = predictionData
        .map(p => ({
            timestamp: new Date(p.timestamp),
            value: parseFloat(p.value)
        }))
        .sort((a, b) => a.timestamp - b.timestamp);

    const currentVal = sortedPredictions[0].value;
    const pred30Val = sortedPredictions[1].value;
    const pred60Val = sortedPredictions[2].value;

    currentGlucoseValueEl.innerText = currentVal.toFixed(2);
    predictionValue30El.innerText = pred30Val.toFixed(2);
    predictionValue60El.innerText = pred60Val.toFixed(2);

    if (sortedPredictions[0].timestamp) {
        lastUpdateTimeEl.innerText = `ì—…ë°ì´íŠ¸: ${moment(sortedPredictions[0].timestamp).tz("Asia/Seoul").fromNow()}`;
    }

    const trendInfoCurrent = getTrendInfo(currentVal, null);
    currentGlucoseTrendEl.innerHTML = `<i class="bi ${trendInfoCurrent.icon}"></i>`;
    currentGlucoseTrendEl.className = `glucose-trend ${trendInfoCurrent.class}`;

    const trendInfo30 = getTrendInfo(pred30Val, currentVal);
    predictionTrend30El.innerHTML = `<i class="bi ${trendInfo30.icon}"></i> ${trendInfo30.change >= 0 ? '+' : ''}${trendInfo30.change}`;
    predictionTrend30El.className = `glucose-trend ${trendInfo30.class}`;

    const trendInfo60 = getTrendInfo(pred60Val, pred30Val);
    predictionTrend60El.innerHTML = `<i class="bi ${trendInfo60.icon}"></i> ${trendInfo60.change >= 0 ? '+' : ''}${trendInfo60.change}`;
    predictionTrend60El.className = `glucose-trend ${trendInfo60.class}`;

    // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì²˜ë¦¬
    if (currentPatientData.target_glucose_range && currentVal != null) {
        const minTarget = currentPatientData.target_glucose_range.min;
        const maxTarget = currentPatientData.target_glucose_range.max;
        let progressPercent = ((currentVal - 40) / 260) * 100;
        progressPercent = Math.max(0, Math.min(100, progressPercent));
        glucoseProgressBarEl.style.width = `${progressPercent}%`;
        glucoseProgressBarEl.className = 'progress-bar';
        if (currentVal < minTarget) glucoseProgressBarEl.classList.add('bg-warning');
        else if (currentVal > maxTarget) glucoseProgressBarEl.classList.add('bg-danger');
        else glucoseProgressBarEl.classList.add('bg-success');
    } else {
        glucoseProgressBarEl.style.width = '0%';
        glucoseProgressBarEl.className = 'progress-bar';
    }
}

        function dismissAlert(closeButton) { closeButton.closest('.alert-card')?.remove(); }

        function updateRecentLogsUI(readings) {
    recentLogsContainerEl.innerHTML = '';
    if (!readings || readings.length === 0) {
        recentLogsContainerEl.innerHTML = '<div class="log-item text-center text-muted p-3">ìµœê·¼ ê¸°ë¡ ì—†ìŒ</div>';
        return;
    }

    const recentReadings = readings.slice().reverse().slice(0, 3); // ìµœì‹  3ê°œ
    recentReadings.forEach(reading => {
        const logDiv = document.createElement('div');
        logDiv.className = 'log-item d-flex justify-content-between align-items-center';
        logDiv.innerHTML = `
            <div>
                <div class="log-time">${moment(reading.timestamp).tz("Asia/Seoul").format('HH:mm')}</div>
                <div class="log-value">${reading.glucose.toFixed(2)} mg/dL</div>
            </div>
            <span class="log-source">${reading.source || 'CGM'}</span>`;
        recentLogsContainerEl.appendChild(logDiv);
    });
}

        function updateAllLogsUI(readings) {
            allLogsContainerEl.innerHTML = '';
            if (!readings || readings.length === 0) {
                allLogsContainerEl.innerHTML = '<div class="log-item text-center text-muted p-3">ì„ íƒëœ ë‚ ì§œì˜ ê¸°ë¡ ì—†ìŒ</div>'; return; }
            readings.slice().reverse().forEach(reading => { // ì‹œê°„ ì—­ìˆœ í‘œì‹œ
                const logDiv = document.createElement('div');
                logDiv.className = 'log-item d-flex justify-content-between align-items-center';
                logDiv.innerHTML = `
                    <div>
                        <div class="log-time">${moment(reading.timestamp).tz("Asia/Seoul").format('YYYY-MM-DD HH:mm')}</div>
                        <div class="log-value">${reading.glucose.toFixed(2)} mg/dL</div>
                    </div>
                    <span class="log-source">${reading.source || 'Unknown'}</span>`;
                allLogsContainerEl.appendChild(logDiv);
            });
        }

        function updateStateLogsUI(states) {
    stateLogsContainerEl.innerHTML = '';
    if (!states || states.length === 0) {
        stateLogsContainerEl.innerHTML = '<div class="log-item text-center text-muted p-3">ìµœê·¼ ìƒíƒœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    states.forEach(state => {
        const logDiv = document.createElement('div');
        logDiv.className = 'log-item d-flex justify-content-between align-items-center';

        const label = state.state || 'ê¸°ë¡';
        const mealStr = state.meal && state.meal > 0 ? `ì‹ì‚¬: ${state.meal} kcal` : '';
        const exerciseStr = state.exercise && state.exercise > 0 ? `ìš´ë™: ${state.exercise} kcal` : '';
        const combinedStr = [mealStr, exerciseStr].filter(Boolean).join(', ');

        logDiv.innerHTML = `
            <div>
                <div class="log-time">${moment(state.time).tz("Asia/Seoul").format('YYYY-MM-DD HH:mm')}</div>
                <div class="log-value">${label}</div>
            </div>
            <span class="log-source">${combinedStr || 'ìƒì„¸ ì—†ìŒ'}</span>
        `;
        stateLogsContainerEl.appendChild(logDiv);
    });
}

        function updateChart(readings, hours = 3) {
            const chartEl = document.getElementById('glucoseChart');
            if (!chartEl) return; // ì°¨íŠ¸ ìš”ì†Œ ì—†ìœ¼ë©´ ì¤‘ë‹¨
            const ctx = chartEl.getContext('2d');
            if (!readings || readings.length === 0) {
                console.warn("ì°¨íŠ¸ ë°ì´í„° ì—†ìŒ");
                if (glucoseChartInstance) { glucoseChartInstance.destroy(); glucoseChartInstance = null; }
                 // í†µê³„ ì´ˆê¸°í™”
                document.getElementById('chartMinGlucose').innerText = '--';
                document.getElementById('chartAvgGlucose').innerText = '--';
                document.getElementById('chartMaxGlucose').innerText = '--';
                document.getElementById('chartTargetRange').innerText = '--%';
                return;
            }

            const labels = readings.map(r => r.timestamp); // ISO ë¬¸ìì—´ ì‚¬ìš©
            const dataPoints = readings.map(r => r.glucose); // value í•„ë“œ ì‚¬ìš©

            const values = dataPoints.filter(v => v != null);
            const minVal = values.length ? Math.min(...values) : null;
            const maxVal = values.length ? Math.max(...values) : null;
            const avgVal = values.length ? Math.round(values.reduce((a, b) => a + b, 0) / values.length) : null;
            let inRangeCount = 0;
            const minTarget = currentPatientData.target_glucose_range?.min || 70;
            const maxTarget = currentPatientData.target_glucose_range?.max || 180;
            if (values.length) { inRangeCount = values.filter(v => v >= minTarget && v <= maxTarget).length; }
            const targetRangePercent = values.length ? Math.round((inRangeCount / values.length) * 100) : 0;

            // í†µê³„ UI ì—…ë°ì´íŠ¸
            document.getElementById('chartMinGlucose').innerText = minVal != null ? `${minVal} mg/dL` : '--';
            document.getElementById('chartAvgGlucose').innerText = avgVal != null ? `${avgVal} mg/dL` : '--';
            document.getElementById('chartMaxGlucose').innerText = maxVal != null ? `${maxVal} mg/dL` : '--';
            document.getElementById('chartTargetRange').innerText = `${targetRangePercent}%`;

            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'í˜ˆë‹¹ (mg/dL)',
                        data: dataPoints,
                        borderColor: 'rgb(0, 82, 204)',
                        backgroundColor: 'rgba(0, 82, 204, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 1,
                        pointHoverRadius: 5
                    },
                    {
                        label: 'ì˜ˆì¸¡ í˜ˆë‹¹ (mg/dL)',
                        data: [],
                        borderColor: 'rgb(255, 165, 0)',
                        borderWidth: 1.5,
                        borderDash: [10, 10],
                            pointRadius: 4,         // â† ì ì˜ í¬ê¸° (ê¸°ë³¸ì€ 3~4)
    pointStyle: 'circle',   // â† ì›í˜• ì 
    fill: false,
    tension: 0.3
                    }
                ]
            };

            async function fetchPredictionsForChart() {
                try {
                    const response = await fetch(`${backendUrl}/api/patients/${patientId}/predictions`);
                    if (!response.ok) throw new Error(`ì˜ˆì¸¡ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ${response.status}`);
                    const data = await response.json();
                    console.log("pre",data);
                    const predictions = data.predictions.map(p => ({
                        x: new Date(p.timestamp.replace(" ", "T")),  // â† ì—¬ê¸°ì„œ ISO í¬ë§·ìœ¼ë¡œ ë³€ê²½         // ë‚ ì§œ íŒŒì‹±
    y: parseFloat(p.value)
                    }));
                    console.log("dddeee",predictions);
                    chartData.datasets[1].data = predictions;
                    if (glucoseChartInstance) {
                        glucoseChartInstance.data = chartData;
                        glucoseChartInstance.update();
                    }
                } catch (error) {
                    console.error('ì˜ˆì¸¡ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
                }
            }

            fetchPredictionsForChart();

            const config = {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
    type: 'time',
    time: {
        unit: hours <= 6 ? 'hour' : 'day',
        displayFormats: {
            hour: 'HH:mm',
            day: 'MM/DD'
        }
    },
    adapters: {
        date: {
            zone: 'Asia/Seoul'
        }
    },
    title: { display: true, text: 'ì‹œê°„' }
},
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'í˜ˆë‹¹ (mg/dL)' },
                            suggestedMin: 40,
                            suggestedMax: 250
                        }
                    },
                    plugins: {
                        tooltip: {
    mode: 'nearest',
    intersect: true,
    callbacks: {
        label: function(context) {
    const value = context.parsed?.y ?? context.raw;
    if (value === undefined || value === null || isNaN(value)) {
        return `${context.dataset.label}: ë°ì´í„° ì—†ìŒ`;
    }
    return `${context.dataset.label}: ${parseFloat(value).toFixed(2)} mg/dL`;
}
    }
},
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: minTarget,
                                    yMax: minTarget,
                                    borderColor: 'rgba(247, 168, 0, 0.5)',
                                    borderWidth: 1,
                                    borderDash: [5, 5],
                                    label: { content: `ì €í˜ˆë‹¹ ê²½ê³„ (${minTarget})`, enabled: true, position: 'start', font: {size: 10} }
                                },
                                line2: {
                                    type: 'line',
                                    yMin: maxTarget,
                                    yMax: maxTarget,
                                    borderColor: 'rgba(233, 79, 55, 0.5)',
                                    borderWidth: 1,
                                    borderDash: [5, 5],
                                    label: { content: `ê³ í˜ˆë‹¹ ê²½ê³„ (${maxTarget})`, enabled: true, position: 'start', font: {size: 10} }
                                }
                            }
                        }
                    }
                }
            };

            if (glucoseChartInstance) { glucoseChartInstance.destroy(); }
            glucoseChartInstance = new Chart(ctx, config);
        }

        // --- ë°ì´í„° ë¡œë”© í•¨ìˆ˜ ---
        async function fetchData(hours = 3) {
    console.log(`ğŸ“¥ fetchData í˜¸ì¶œ (hours: ${hours})`);
    showLoading('ë°ì´í„° ë¡œë”© ì¤‘...');

    let predictionData = null;
    let alertData = null;
    let glucoseData = null;
    let patientData = null;
    let fetchError = null;

    try {
        const responses = await Promise.all([
            fetch(`${backendUrl}/api/patients/${patientId}`).catch(err => {
                console.error('âŒ í™˜ì ë°ì´í„° ì˜¤ë¥˜:', err);
                return null;
            }),
            fetch(`${backendUrl}/api/patients/${patientId}/predictions`).catch(err => {
                console.error('âŒ ì˜ˆì¸¡ ë°ì´í„° ì˜¤ë¥˜:', err);
                return null;
            }),
            fetch(`${backendUrl}/api/patients/${patientId}/alerts?active_only=true`).catch(err => {
                console.error('âŒ ì•Œë¦¼ ë°ì´í„° ì˜¤ë¥˜:', err);
                return null;
            }),
            fetch(`${backendUrl}/api/patients/${patientId}/glucose`).catch(err => {
                console.error('âŒ í˜ˆë‹¹ ë°ì´í„° ì˜¤ë¥˜:', err);
                return null;
            }),
            fetch(`${backendUrl}/api/patients/${patientId}/states`).catch(err => {
                console.error('âŒ ìƒíƒœ ë°ì´í„° ì˜¤ë¥˜:', err);
                return null;
            })
        ]);

        // ì‘ë‹µ ì²˜ë¦¬
        if (responses[0] && responses[0].ok) {
            patientData = await responses[0].json();
        } else {
            console.error("âš ï¸ í™˜ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", responses[0]);
        }

        if (responses[1] && responses[1].ok) {
            predictionData = await responses[1].json();
        } else {
            console.error("âš ï¸ ì˜ˆì¸¡ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", responses[1]);
        }

        if (responses[2] && responses[2].ok) {
            alertData = await responses[2].json();
        } else {
            console.error("âš ï¸ ì•Œë¦¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", responses[2]);
        }

        if (responses[3] && responses[3].ok) {
            glucoseData = await responses[3].json();
        } else {
            console.error("âš ï¸ í˜ˆë‹¹ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", responses[3]);
        }
        if (responses[4] && responses[4].ok) {
    const stateData = await responses[4].json();
    updateStateLogsUI(stateData.states || stateData);
}

        // í•„ìˆ˜ ë°ì´í„° ì—†ìœ¼ë©´ ì‹¤íŒ¨ ì²˜ë¦¬
        if (!patientData || !glucoseData || !predictionData) {
            alert('ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
            fetchError = new Error("í•„ìˆ˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
        }

    } catch (error) {
        fetchError = error;
        console.error("âŒ fetchData ì˜ˆì™¸:", error);
    } finally {
        hideLoading();

        if (fetchError) {
            currentGlucoseValueEl.innerText = 'ì˜¤ë¥˜';
            predictionValue30El.innerText = 'ì˜¤ë¥˜';
            predictionValue60El.innerText = 'ì˜¤ë¥˜';
            recentLogsContainerEl.innerHTML = '<div class="log-item text-center text-danger p-3">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
            if (glucoseChartInstance) {
                glucoseChartInstance.destroy();
                glucoseChartInstance = null;
            }
            return;
        }

        // --- ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸ ---
        if (patientData) updatePatientInfoUI(patientData);

        if (predictionData?.predictions) {
            updatePredictionUI(predictionData.predictions);  // ë°°ì—´ë¡œ ë„˜ê¹€
        }

        if (alertData?.alerts) {
            updateAlertUI(alertData.alerts);
        }

        if (glucoseData) {
            // readingsê°€ ìˆìœ¼ë©´ readings ì‚¬ìš©, ì—†ìœ¼ë©´ ìì²´ ë°°ì—´ë¡œ ê°„ì£¼
            const readings = Array.isArray(glucoseData.readings) ? glucoseData.readings : glucoseData;

            console.log("âœ… ë¡œë”©ëœ í˜ˆë‹¹ ê¸°ë¡ ìˆ˜:", readings.length);
            updateRecentLogsUI(readings);
            updateChart(readings, hours);
        }
    }
}

        async function fetchAllLogs(dateStr) {
    showLoading('ì „ì²´ ê¸°ë¡ ë¡œë”© ì¤‘...');
    try {
        const response = await fetch(`${backendUrl}/api/patients/${patientId}/glucose`);
        if (response.ok) {
            const data = await response.json();
            const readings = Array.isArray(data.readings) ? data.readings : [];

            // ë‚ ì§œë³„ í•„í„°
            const filteredReadings = readings.filter(r => {
                if (!r.timestamp) return false;
                const dayStr = moment(r.timestamp).tz("Asia/Seoul").format("YYYY-MM-DD");
                return dayStr === dateStr;
            });

            // 1. ì „ì²´ ê¸°ë¡ UI
            updateAllLogsUI(filteredReadings);

            // 2. ìµœê·¼ ê¸°ë¡ UI (ìƒë‹¨ ìµœê·¼ 3ê°œ)
            updateRecentLogsUI(filteredReadings);

            // 3. ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            updateChart(filteredReadings, 24);  // ì „ì²´ ê¸°ë¡ì€ í•˜ë£¨ ê¸°ì¤€

            // 4. í˜„ì¬ í˜ˆë‹¹ ë° íŠ¸ë Œë“œ ë°” (ê°€ì¥ ìµœì‹  ë°ì´í„° ê¸°ì¤€)
            if (filteredReadings.length > 0) {
                const latest = filteredReadings[filteredReadings.length - 1];
                const previous = filteredReadings.length >= 2
                    ? filteredReadings[filteredReadings.length - 2]
                    : null;

                const currentVal = latest.glucose;
                const prevVal = previous?.glucose ?? null;

                currentGlucoseValueEl.innerText = currentVal.toFixed(2);
                lastUpdateTimeEl.innerText = `ì—…ë°ì´íŠ¸: ${moment(latest.timestamp).tz("Asia/Seoul").fromNow()}`;

                const trendInfo = getTrendInfo(currentVal, prevVal);
                currentGlucoseTrendEl.innerHTML = `<i class="bi ${trendInfo.icon}"></i>`;
                currentGlucoseTrendEl.className = `glucose-trend ${trendInfo.class}`;

                // Progress bar ì—…ë°ì´íŠ¸
                const minTarget = currentPatientData.target_glucose_range?.min || 70;
                const maxTarget = currentPatientData.target_glucose_range?.max || 180;
                let progressPercent = ((currentVal - 40) / 260) * 100;
                progressPercent = Math.max(0, Math.min(100, progressPercent));
                glucoseProgressBarEl.style.width = `${progressPercent}%`;
                glucoseProgressBarEl.classList.remove('bg-success', 'bg-warning', 'bg-danger');
                if (currentVal < minTarget) {
                    glucoseProgressBarEl.classList.add('bg-warning');
                } else if (currentVal > maxTarget) {
                    glucoseProgressBarEl.classList.add('bg-danger');
                } else {
                    glucoseProgressBarEl.classList.add('bg-success');
                }
            }

        } else {
            throw new Error('Failed to load logs');
        }
    } catch (error) {
        console.error("ì „ì²´ ê¸°ë¡ ë¡œë”© ì˜¤ë¥˜:", error);
        allLogsContainerEl.innerHTML = '<div class="log-item text-center text-danger p-3">ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨</div>';
    } finally {
        hideLoading();
    }
}

        async function submitState() {
    const state = document.getElementById('stateInput').value.trim();
    const amount = parseFloat(document.getElementById('mealInput').value);
    if (!state || isNaN(amount)) {
        alert('ìƒíƒœì™€ ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }

    // ìƒíƒœì— ë”°ë¼ í•„ë“œë¥¼ ê²°ì •
    let payload = {};
    if (state === 'ì‹ì‚¬') {
        payload = { meal: amount };
    } else if (state === 'ìš´ë™') {
        payload = { exercise: amount };
    } else {
        alert('ìƒíƒœëŠ” "ì‹ì‚¬" ë˜ëŠ” "ìš´ë™"ë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }

    showLoading('ìƒíƒœ ì…ë ¥ ì¤‘...');
    try {
        const response = await fetch(`${backendUrl}/api/patients/${patientId}/states`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (response.ok) {
            document.getElementById('stateInput').value = '';
            document.getElementById('mealInput').value = '';
            fetchData(currentChartHours);
        } else {
            const errorResult = await response.json();
            alert(`ìƒíƒœ ì…ë ¥ ì‹¤íŒ¨: ${errorResult.error}`);
        }
    } catch (error) {
        console.error('ìƒíƒœ ì…ë ¥ ì˜¤ë¥˜:', error);
        alert('ìƒíƒœ ì…ë ¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
    } finally {
        hideLoading();
    }
}

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        document.getElementById('emergencyBtn').addEventListener('click', async () => {
            if (!confirm('ê¸´ê¸‰ ì›ê²© ì§„ë£Œë¥¼ ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë‹´ë‹¹ ì˜ì‚¬ì—ê²Œ ì•Œë¦¼ì´ ê°‘ë‹ˆë‹¤.')) return;
            showLoading('ê¸´ê¸‰ ì—°ê²° ìš”ì²­ ì¤‘...');
            try {
                const response = await fetch(`${backendUrl}/api/webex/emergency_connect`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    // ì¤‘ìš”: requesting_user_id ë¥¼ ì‹¤ì œ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì IDë¡œ ë³´ë‚´ì•¼ í•¨
                    body: JSON.stringify({ patient_id: patientId, requesting_user_id: 'doctor1' }) // ì„ì‹œ doctor1
                });
                hideLoading(); // ì‘ë‹µ ì˜¤ë©´ ë¡œë”© ìˆ¨ê¹€
                const result = await response.json(); // í•­ìƒ json íŒŒì‹± ì‹œë„
                if (response.ok) {
                    alert(`ê¸´ê¸‰ ì—°ê²° ìš”ì²­ ì„±ê³µ! ì°¸ì—¬ URL(ì°¸ê³ ): ${result.joinUrl || result.id}`);
                } else {
                     if (response.status === 401 && result.reauth_url) {
                         // 401 ì—ëŸ¬ ë° ì¬ì¸ì¦ URL ìˆìœ¼ë©´ ì‚¬ìš©ì ì¬ì¸ì¦ ìœ ë„
                         if (confirm("Webex ì¸ì¦ì´ í•„ìš”í•˜ê±°ë‚˜ í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. Webex ì¸ì¦ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                              window.location.href = result.reauth_url;
                         } else {
                              alert("Webex ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                         }
                     } else {
                         alert(`ê¸´ê¸‰ ì—°ê²° ì‹¤íŒ¨: ${result.error || response.statusText}`);
                     }
                }
            } catch (error) {
                hideLoading(); console.error('ê¸´ê¸‰ ì—°ê²° ìš”ì²­ ì˜¤ë¥˜:', error);
                alert('ê¸´ê¸‰ ì—°ê²° ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            }
        });

        // í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ íƒ­ ì „í™˜ (fetchData í˜¸ì¶œ ë¡œì§ ìˆ˜ì •ë¨)
        bottomNavLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const targetId = link.getAttribute('data-target');
                if (!targetId && link.id !== 'settingsBtn') return; // data-target ì—†ê±°ë‚˜ ì„¤ì •ë²„íŠ¼ ì•„ë‹ˆë©´ ë¬´ì‹œ

                if (link.id === 'settingsBtn') {
                     // TODO: ì„¤ì • í™”ë©´ ë˜ëŠ” Webex ì¸ì¦ ì‹œì‘ ë¡œì§ ì—°ê²°
                     // ì„ì‹œë¡œ Webex ì¸ì¦ ì‹œì‘
                     if (confirm("Webex ê³„ì •ì„ ì—°ê²°/ì¬ì¸ì¦í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                          // 'doctor1'ì„ ì‹¤ì œ ë¡œê·¸ì¸ëœ ì˜ì‚¬ IDë¡œ ë³€ê²½ í•„ìš”
                          window.location.href = `${backendUrl}/api/webex/auth/initiate?user_id=doctor1`;
                     }
                     return;
                }

                homeContent.style.display = 'none'; chartContent.style.display = 'none'; logContent.style.display = 'none';
                bottomNavLinks.forEach(l => l.classList.remove('active'));
                const targetElement = document.getElementById(targetId);
                if (targetElement) targetElement.style.display = 'block';
                link.classList.add('active');

                // íƒ­ ì „í™˜ ì‹œ ë°ì´í„° ìƒˆë¡œ ê³ ì¹¨
                if (targetId === 'logContent') {
                    const today = new Date().toISOString().split('T')[0];
                    logDateFilterEl.value = today; fetchAllLogs(today);
                } else {
                    // í™ˆ ë˜ëŠ” ì°¨íŠ¸ íƒ­ì´ë©´ fetchData í˜¸ì¶œ
                    fetchData(targetId === 'chartContent' ? currentChartHours : 3);
                }
            });
        });

        // ì°¨íŠ¸ ì‹œê°„ ë²”ìœ„ ì„ íƒ ë²„íŠ¼
        timeSelectorBtns.forEach(btn => {
             btn.addEventListener('click', () => {
                 timeSelectorBtns.forEach(b => b.classList.remove('active')); btn.classList.add('active');
                 currentChartHours = parseInt(btn.getAttribute('data-hours'));
                 fetchData(currentChartHours); // ì„ íƒëœ ì‹œê°„ìœ¼ë¡œ ì°¨íŠ¸ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
            });
        });

        // ì „ì²´ ë¡œê·¸ ë‚ ì§œ í•„í„°
        logDateFilterEl.addEventListener('change', (event) => { fetchAllLogs(event.target.value); });
        // ìƒì„¸ ì˜ˆì¸¡ ë²„íŠ¼
        document.getElementById('viewPredictionBtn').addEventListener('click', () => { document.querySelector('.nav-link[data-target="chartContent"]').click(); });
        // ëª¨ë‘ ë³´ê¸° ë²„íŠ¼
        document.getElementById('viewAllLogsBtn').addEventListener('click', () => { document.querySelector('.nav-link[data-target="logContent"]').click(); });

        // --- ì´ˆê¸° ë°ì´í„° ë¡œë“œ ---
        document.addEventListener('DOMContentLoaded', () => {
             fetchData(currentChartHours); // í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆ ë°ì´í„° ë¡œë“œ
             // ìë™ ì—…ë°ì´íŠ¸ ì œê±°
             // setInterval(fetchData, 30000);
        });
    </script>
</body>
</html>
